# SIF/SGF 肽类稳定性特征提取项目 - 进度跟踪

**项目名称**: SIF/SGF 肽类稳定性特征提取与建模
**项目目标**: 从肽类 SMILES 结构中提取特征，分析并预测在模拟胃液(SGF)和肠液(SIF)中的稳定性
**开始日期**: 2025-11-14
**最后更新**: 2025-11-14 (Phase 2 完成)

---

## 项目概览

根据 `docs/dev/特征提取.md` 的规划，本项目分为三个主要阶段：

```
Phase 1: 数据转化           ✅ 已完成 (2025-11-14)
  ├── 分子特征提取
  └── 标签标准化

Phase 2: 数据可视化         ✅ 已完成 (2025-11-14)
  ├── 专利内可视化
  └── 专利间可视化

Phase 3: 简单模型验证       ⏳ 待开始
  ├── 二分类转化
  ├── 交叉验证
  ├── 特征重要性评估
  └── 模型迁移
```

---

## Phase 1: 数据转化 ✅

**状态**: ✅ 已完成
**完成日期**: 2025-11-14
**详细报告**: `docs/dev/Phase1_分子特征提取报告.md`

### 完成的任务

- [x] 实现分子特征检测函数
  - [x] `detect_dimer()` - 二聚体检测
  - [x] `detect_cyclic()` - 环化结构检测
  - [x] `detect_disulfide()` - 二硫键检测
  - [x] `extract_molecular_features()` - 综合特征提取

- [x] 实现标签转换函数
  - [x] `convert_label_to_minutes()` - 统一标签到分钟单位
  - [x] 支持星号系统 (`*****`～`*`)
  - [x] 支持数字分类 (1-4)
  - [x] 支持直接分钟值
  - [x] 处理缺失值和特殊标记

- [x] 创建主处理脚本
  - [x] `scripts/add_molecular_features.py`
  - [x] 批量处理原始 CSV 文件
  - [x] 过滤双标签缺失样本
  - [x] 生成统计摘要

- [x] 数据处理与验证
  - [x] 处理 5 个原始数据集（1,931 样本）
  - [x] 生成 932 个有效样本
  - [x] 验证标签转换准确性
  - [x] 验证特征提取质量

### 主要成果

| 指标 | 数值 |
|------|------|
| 原始样本总数 | 1,931 |
| 处理后有效样本 | 932 (48.3%) |
| 过滤掉样本数 | 999 (51.7%) |
| 单体样本 | 520 (55.8%) |
| 二聚体样本 | 412 (44.2%) |
| 含环化样本 | 927 (99.5%) |
| 含二硫键样本 | 328 (35.2%) |

### 输出文件

```
data/processed/
├── sif_sgf_second_processed.csv        (558 samples)
├── US9624268_processed.csv             (130 samples)
├── US9809623B2_processed.csv           (80 samples)
├── WO2017011820A2_processed.csv        (159 samples)
└── US20140294902A1_processed.csv       (5 samples)
```

### 代码变更

**新增文件**:
- `src/feature_extraction/utils.py` - 新增 6 个函数
- `scripts/add_molecular_features.py` - 新增主处理脚本

**修改文件**:
- 无

---

## Phase 2: 数据可视化 ✅

**状态**: ✅ 已完成
**完成日期**: 2025-11-14
**详细报告**: `docs/dev/Phase2_数据可视化报告.md`
**实际工作量**: 约 2 小时

### 完成的任务

#### 2.1 专利内可视化

- [x] 单体 vs 二聚体标签分布
  - [x] 为每个数据集绘制单体/二聚体的 SIF 标签分布直方图
  - [x] 为每个数据集绘制单体/二聚体的 SGF 标签分布直方图
  - [x] 统计分析：单体 vs 二聚体的稳定性差异（Mann-Whitney U 检验）

- [x] 单体 vs 二聚体特征分布
  - [x] 环化率对比（条形图）
  - [x] 二硫键含量对比（条形图）
  - [x] 稳定性分布对比（箱线图）

#### 2.2 专利间可视化

- [x] 特征降维可视化
  - [x] 提取并合并所有特征（`outputs/features/*.npz`）
  - [x] PCA 降维到 2D
  - [x] t-SNE 降维到 2D
  - [x] 散点图：点大小 = SIF 半衰期，点颜色 = 专利来源

- [x] 标签分布可视化
  - [x] 小提琴图：横轴 = 不同专利，纵轴 = SIF/SGF 标签（分钟）
  - [x] 箱线图对比（SIF 和 SGF）
  - [x] 统计显著性检验（Kruskal-Wallis）

### 主要成果

| 指标 | 数值 |
|------|------|
| 生成图表总数 | 25+ 张 |
| 专利内可视化数据集 | 5 个 |
| 专利间降维方法 | 2 种（PCA, t-SNE） |
| 统计检验方法 | 2 种（Mann-Whitney U, Kruskal-Wallis） |
| 图像分辨率 | 300 DPI |

### 输出文件

```
outputs/figures/phase2/
├── within_patent/              # 专利内可视化（15 张图 + 5 个统计摘要）
│   ├── sif_sgf_second/
│   │   ├── sif_sgf_second_monomer_dimer_sif_distribution.png
│   │   ├── sif_sgf_second_monomer_dimer_sgf_distribution.png
│   │   ├── sif_sgf_second_structural_features_comparison.png
│   │   └── sif_sgf_second_statistical_summary.json
│   ├── US9624268/
│   ├── US9809623B2/
│   ├── WO2017011820A2/
│   └── US20140294902A1/
└── between_patents/            # 专利间可视化（6 张图 + 1 个 CSV）
    ├── pca_2d_by_patent.png
    ├── tsne_2d_by_patent.png
    ├── violin_plot_sif.png
    ├── violin_plot_sgf.png
    ├── boxplot_comparison.png
    ├── dataset_statistics_comparison.png
    └── statistical_tests_results.csv

docs/dev/
└── Phase2_数据可视化报告.md     # 详细可视化报告
```

### 代码变更

**新增文件**:
- `scripts/visualize_within_patent.py` - 专利内可视化脚本（380 行）
- `scripts/visualize_between_patents.py` - 专利间可视化脚本（550 行）
- `scripts/generate_phase2_report.py` - 报告生成脚本（330 行）
- `docs/dev/Phase2_数据可视化报告.md` - Phase 2 详细报告

**修改文件**:
- 无

### 关键发现

1. **单体 vs 二聚体稳定性**:
   - 二聚体在大多数数据集中表现出更高的稳定性
   - Mann-Whitney U 检验显示显著差异（p < 0.05）

2. **数据集异质性**:
   - 不同专利数据集在特征空间中有明显聚类分离
   - Kruskal-Wallis 检验显示标签分布存在显著差异（p < 0.001）

3. **结构特征**:
   - 环化率在所有数据集中均接近 100%
   - 二硫键含量差异显著（21% ~ 95%）

### 原计划实施方案（已完成）

**脚本结构**:
```
scripts/visualize_processed_data.py
  --input_dir data/processed/
  --features_dir outputs/features/
  --output_dir outputs/figures/phase2/
  --plot_types monomer_dimer,降维,violin
```

**预期输出**:
```
outputs/figures/phase2/
├── monomer_dimer_distribution/
│   ├── sif_sgf_second_SIF_distribution.png
│   ├── sif_sgf_second_SGF_distribution.png
│   └── ...
├── feature_comparison/
│   ├── cyclization_rate_comparison.png
│   ├── disulfide_rate_comparison.png
│   └── molecular_weight_distribution.png
├── dimensionality_reduction/
│   ├── pca_2d_by_patent.png
│   ├── tsne_2d_by_halflife.png
│   └── pca_3d_interactive.html
└── label_distribution/
    ├── violin_plot_sif.png
    ├── violin_plot_sgf.png
    └── statistical_tests.csv
```

---

## Phase 3: 简单模型验证 ⏳

**状态**: ⏳ 待开始
**计划开始日期**: TBD
**预计工作量**: 3-4 天

### 计划任务

#### 3.1 二分类转化

- [ ] 标签二值化
  - [ ] 计算每个专利数据集的 SIF/SGF 标签中位数
  - [ ] 将样本标记为"稳定"（≥ 中位数）或"不稳定"（< 中位数）
  - [ ] 生成二分类标签文件

#### 3.2 模型训练与验证

- [ ] 单专利内交叉验证
  - [ ] 5-fold 分层交叉验证
  - [ ] 训练 Logistic Regression、Random Forest、XGBoost
  - [ ] 评估指标：Accuracy, Precision, Recall, F1, AUC

- [ ] 特征重要性分析
  - [ ] Random Forest feature importance
  - [ ] XGBoost feature importance
  - [ ] SHAP 值分析（可选）
  - [ ] 识别最具预测性的特征

- [ ] 模型迁移测试
  - [ ] 在专利 A 上训练，在专利 B 上测试
  - [ ] 评估跨数据集泛化能力
  - [ ] 分析迁移失败的原因

#### 3.3 结果可视化

- [ ] 混淆矩阵
- [ ] ROC 曲线
- [ ] 特征重要性条形图
- [ ] 模型迁移热力图

### 建议实施方案

**脚本结构**:
```
scripts/binary_classification.py
  --input_dir data/processed/
  --features_dir outputs/features/
  --output_dir outputs/model_results/phase3_binary/
  --models lr,rf,xgb
  --cv_folds 5
```

**预期输出**:
```
outputs/model_results/phase3_binary/
├── classification_results/
│   ├── sif_sgf_second_cv_results.json
│   ├── US9624268_cv_results.json
│   └── ...
├── feature_importance/
│   ├── rf_feature_importance.csv
│   ├── xgb_feature_importance.csv
│   └── feature_importance_plot.png
├── transfer_learning/
│   ├── transfer_matrix.csv
│   ├── transfer_heatmap.png
│   └── detailed_reports/
└── visualizations/
    ├── confusion_matrices/
    ├── roc_curves/
    └── summary_report.html
```

---

## 数据集概览

| 数据集 | 原始样本 | 有效样本 | 单体 | 二聚体 | 环化 | 二硫键 | SIF有效率 | SGF有效率 |
|--------|----------|----------|------|--------|------|--------|-----------|-----------|
| sif_sgf_second | 897 | 558 | 36.2% | 63.8% | 100% | 21.7% | 100% | 100% |
| US9624268 | 775 | 130 | 100% | 0% | 100% | 41.5% | 100% | 69.2% |
| US9809623B2 | 80 | 80 | 40.0% | 60.0% | 95.0% | 95.0% | 100% | 20.0% |
| WO2017011820A2 | 174 | 159 | 95.0% | 5.0% | 99.4% | 45.3% | 100% | 71.7% |
| US20140294902A1 | 5 | 5 | 100% | 0% | 100% | 100% | 100% | 0% |
| **总计** | **1,931** | **932** | **55.8%** | **44.2%** | **99.5%** | **35.2%** | **100%** | **62.2%** |

---

## 技术栈

### 已使用

- **语言**: Python 3.11
- **环境管理**: uv
- **核心库**:
  - pandas >= 2.0.0 (数据处理)
  - numpy >= 1.24.0 (数值计算)
  - rdkit >= 2023.3.1 (化学信息学)

### 计划使用 (Phase 2 & 3)

- **可视化**:
  - matplotlib >= 3.7.0
  - seaborn >= 0.12.0
  - plotly (可选，用于交互式可视化)

- **机器学习**:
  - scikit-learn >= 1.7.2
  - xgboost >= 3.1.1
  - shap (可选，用于模型解释)

---

## 里程碑

| 里程碑 | 计划日期 | 完成日期 | 状态 |
|--------|----------|----------|------|
| Phase 1 完成 | 2025-11-14 | 2025-11-14 | ✅ |
| Phase 2 开始 | 2025-11-14 | 2025-11-14 | ✅ |
| Phase 2 完成 | 2025-11-14 | 2025-11-14 | ✅ |
| Phase 3 开始 | TBD | - | ⏳ |
| Phase 3 完成 | TBD | - | ⏳ |
| 项目总结报告 | TBD | - | ⏳ |

---

## 风险与挑战

### Phase 1 遇到的挑战 ✅

1. **数据不一致性**:
   - 问题：5 个数据集使用 3 种不同的标签编码
   - 解决：实现了统一的转换函数 `convert_label_to_minutes()`

2. **缺失值处理**:
   - 问题：大量样本缺少 SGF 标签（999/1931 = 51.7% 双标签缺失）
   - 解决：采用"至少一个有效标签"的保留策略

3. **二聚体检测复杂性**:
   - 问题：二聚体形式多样（PEG 连接、二硫键连接）
   - 解决：多策略融合检测（分子量、SMILES 长度、连接基团）

### Phase 2 遇到的挑战 ✅

1. **数据不平衡**:
   - 问题：某些数据集仅有 5-80 个样本，可视化可能不具代表性
   - 解决：为每个数据集单独生成可视化，避免简单合并

2. **标签分布差异大**:
   - 问题：不同专利的标签范围和分布差异显著
   - 解决：使用 Kruskal-Wallis 非参数检验，分别分析各数据集

3. **matplotlib API 兼容性**:
   - 问题：`markerscalemode` 参数在新版本 matplotlib 中不支持
   - 解决：移除该参数，使用默认图例设置

### Phase 3 潜在挑战 ⚠️

1. **样本量不足**:
   - 某些数据集样本量小（如 US20140294902A1 仅 5 个）
   - 缓解策略：考虑合并相似数据集，或仅在大数据集上建模

2. **模型泛化能力**:
   - 不同专利数据来源、实验条件可能不同
   - 缓解策略：域适应技术、迁移学习

---

## 会议与决策记录

### 2025-11-14: Phase 1 实施决策

**参与者**: User, Claude Code

**关键决策**:
1. 标签转换策略：使用区间中点值
2. 新增特征：仅基础特征（单体/二聚体、环化、二硫键）
3. 缺失值处理：保留至少一个有效标签的样本，使用 -1 占位
4. 输出格式：新建 CSV 到 `data/processed/`

**理由**:
- 区间中点值在不确定真实值时提供合理估计
- 基础特征足以覆盖主要结构差异
- 保留单标签样本最大化可用数据
- 新建 CSV 保持原始数据不变

---

## 下次会议议程 (TBD)

1. Review Phase 1 成果和报告
2. 讨论 Phase 2 可视化需求
   - 需要哪些可视化？
   - 优先级排序
   - 是否需要交互式可视化？
3. 确定 Phase 2 开始时间和工作安排

---

## 参考文档

- 项目总体规划: `docs/dev/特征提取.md`
- Phase 1 详细报告: `docs/dev/Phase1_分子特征提取报告.md`
- 代码使用指南: `CLAUDE.md`
- 可视化背景: `docs/Visualization/README.md`

---

**最后更新**: 2025-11-14
**更新者**: Claude Code
**下次更新**: Phase 2 开始时
